@page "/main-offer"

@inject NavigationManager Navigation
@inject ExchangeOrderService ExchangeOrderService
@inject ISnackbar Snackbar
@inject UserService UserService

@if (UserService.IsAuthorized())
{
    <div class="block-1">
        <div style="width: 100%;">
            <div style="width: 50%; float: left">
                <div class="header">
                    <h3 style="display: flex; justify-content:center">Ваши предметы: </h3>
                </div>
                <div class="card-group">
                    @foreach (var exch in ExchangeOrderService.SenderOrders)
                    {
                        <div class="item-card" style="margin: 2%">
                            <MudCard Outlined="true">
                                <MudCardHeader Style="height: 20px">
                                    <CardHeaderAvatar>
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="() => RemoveOrder(exch)" />
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent Class="d-flex justify-center align-center">
                                    <div class="image">
                                        <MudImage Src=@("Images/" + @exch.PhotoName) Elevation="25" Class="rounded-lg" Style="width: 100%; height: 100%" />
                                    </div>                
                                </MudCardContent>
                                <MudCardActions style="display: flex; justify-content:center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => OpenOrderPage(exch.ExchangeOrderId)" Style="width: 100%; height: 100%"><div class="name-card">@ExchangeOrderService.CutName(exch.Title)</div></MudButton>
                                </MudCardActions>
                            </MudCard>
                        </div>
                    }
                </div>
                <div class="form-group" style="display: flex; justify-content:center; margin: 0 0 5% 0">
                    <button class="btn btn-primary" @onclick=SenderOfferExchange>Добавить предмет для обмена</button>
                </div>
            </div>
            <div style="width: 50%; float: left">
                <div class="header">
                    <h3 style="display: flex; justify-content:center">Предметы на обмен: </h3>
                </div>
                <div class="card-group">
                    @foreach (var exch in ExchangeOrderService.RecepientOrders)
                    {
                        <div class="item-card" style="margin: 2%">
                            <MudCard Outlined="true" >
                                <MudCardHeader Style="height: 20px">
                                    <CardHeaderAvatar>
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="() => RemoveOrder(exch)" />
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent Class="d-flex justify-center align-center">
                                    <div class="image">
                                        <MudImage Src=@("Images/" + @exch.PhotoName) Elevation="25" Class="rounded-lg" Style="width: 100%; height: 100%" />
                                    </div>
                                </MudCardContent>
                                <MudCardActions style="display: flex; justify-content:center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => OpenOrderPage(exch.ExchangeOrderId)"><div class="name-card">@ExchangeOrderService.CutName(exch.Title)</div></MudButton>
                                </MudCardActions>
                            </MudCard>
                        </div>
                    }
                </div>
                <div class="form-group" style="display: flex; justify-content:center; margin: 0 0 5% 0">
                    <button class="btn btn-primary" @onclick=RecepientOfferExchange>Добавить предмет для обмена</button>
                </div>
            </div>
        </div>
    </div>
    <div style="width: 100%; display: flex; justify-content:center; margin: 0 0 5% 0">
        <button class="btn btn-primary" @onclick=SaveOfferExchange style="display: block; margin-left: auto; margin-right: auto">Предложить обмен</button>
    </div>
}
else
{
    <NotAuthorizedComponent></NotAuthorizedComponent>
}

@code {

    private void OpenOrderPage(int id)
    {
        Navigation.NavigateTo("/order");
        ExchangeOrderService.ChangeCurrentExchangeOrder(id);
    }

    private void SenderOfferExchange()
    {
        if(ExchangeOrderService.ValueItemType != 0 && ExchangeOrderService.SenderOrders.Count() != 0)
        {
            Snackbar.Add("Предметы для создания рекомендованного обмена уже добавлены!", Severity.Warning);
            return;
        }
        Navigation.NavigateTo("/offer-exchange-orders");
        ExchangeOrderService.IsSenderOrders = true;
    }

    private void RecepientOfferExchange()
    {
        if (ExchangeOrderService.ValueItemType != 0 && ExchangeOrderService.RecepientOrders.Count() != 0)
        {
            Snackbar.Add("Предметы для создания рекомендованного обмена уже добавлены!", Severity.Warning);
            return;
        }
        Navigation.NavigateTo("/offer-exchange-orders");
        ExchangeOrderService.IsSenderOrders = false;
    }

    private void SaveOfferExchange()
    {
        if (!ExchangeOrderService.CheckFullnessList())
        {
            Snackbar.Add("Для создания обмена предметы должны предоставляться с двух сторон участников обмена!", Severity.Error);
            return;
        }

        if(ExchangeOrderService.CheckExchangeOrderOffer())
        {
            Snackbar.Add("Такой обмен уже создан!", Severity.Warning);
            return;
        }

        ExchangeOrderService.SaveExchageOrderOffer();
        ExchangeOrderService.ClearLists();
        Navigation.NavigateTo("/main");
        Snackbar.Add("Предложение обмена успешно создано!", Severity.Success);
    }

    private void RemoveOrder(ExchangeOrder order)
    {
        if(order.ExchangeOrderId == ExchangeOrderService.RecepientOrders.First().ExchangeOrderId)
        {
            Snackbar.Add("Нельзя удалять первоначальный предмет обмена!", Severity.Error);
            return;
        }

        if(ExchangeOrderService.ValueItemType != 0)
        {
            Snackbar.Add("Нельзя удалять предметы из рекомендованного обмена!", Severity.Error);
            return;
        }

        foreach(var o in ExchangeOrderService.SenderOrders)
        {
            if(order.ExchangeOrderId == o.ExchangeOrderId)
            {
                ExchangeOrderService.SenderOrders.Remove(o);
                Snackbar.Add("Предмет успешно удален из создаваемого предложения обмена!", Severity.Success);
                return;
            }
        }

        foreach (var o in ExchangeOrderService.RecepientOrders)
        {
            if (order.ExchangeOrderId == o.ExchangeOrderId)
            {
                ExchangeOrderService.RecepientOrders.Remove(o);
                Snackbar.Add("Предмет успешно удален из создаваемого предложения обмена!", Severity.Success);
                return;
            }
        }
    }
}
